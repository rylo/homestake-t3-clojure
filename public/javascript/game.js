// Generated by CoffeeScript 1.6.2
(function() {
  var _ref,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

  window.Game = (function(_super) {
    __extends(Game, _super);

    function Game() {
      _ref = Game.__super__.constructor.apply(this, arguments);
      return _ref;
    }

    Game.prototype.defaults = {
      board: new Board,
      players: {
        player1: {
          type: 'human',
          marker: 'x'
        },
        player2: {
          type: 'ultimate',
          marker: 'o'
        }
      },
      currentPlayer: 'x',
      message: "x's turn"
    };

    Game.prototype.url = function() {
      return '/json';
    };

    Game.prototype.initialize = function() {
      var _this = this;

      return this.listenTo(this.get('board'), 'change', function() {
        return _this.trigger('change');
      });
    };

    Game.prototype.sync = function(callback) {
      var dataHash, url,
        _this = this;

      url = this.url();
      dataHash = this.dataHash();
      return $.ajax(url, {
        data: dataHash,
        error: function(jqXHR, textStatus, errorThrown) {
          return "error";
        },
        success: function(data, textStatus, jqXHR) {
          return _this.parse(data);
        }
      });
    };

    Game.prototype.dataHash = function() {
      return $.extend({
        move: this.get('currentMove'),
        marker: this.get('currentPlayer'),
        player1: this.get('players').player1.marker,
        player1type: this.get('players').player1.type,
        player2: this.get('players').player2.marker,
        player2type: this.get('players').player2.type
      }, this.boardHash());
    };

    Game.prototype.boardHash = function() {
      var hash, space_number, value;

      hash = (function() {
        var _ref1, _results;

        _ref1 = this.get('board').get('spaces');
        _results = [];
        for (space_number in _ref1) {
          value = _ref1[space_number];
          _results.push("\"" + space_number + "\":\"" + value + "\"");
        }
        return _results;
      }).call(this);
      return $.parseJSON("{" + hash + "}");
    };

    Game.prototype.parse = function(data) {
      var board;

      board = this.get('board');
      board.set('spaces', this.parseBoard(data.board));
      board.unlock();
      this.set('currentPlayer', data.currentPlayer);
      return this.set('message', data.message);
    };

    Game.prototype.parseBoard = function(board_array) {
      var board, space_number, value;

      return board = (function() {
        var _results;

        _results = [];
        for (space_number in board_array) {
          value = board_array[space_number];
          if (value === 'nil') {
            _results.push(null);
          } else {
            _results.push(value);
          }
        }
        return _results;
      })();
    };

    return Game;

  })(Backbone.Model);

}).call(this);
